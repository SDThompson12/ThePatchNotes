"use strict";var Promise=require("bluebird"),superagent=require("superagent"),helper=require("../utils/Helper"),fs=require("fs"),path=require("path"),TURBO_VECTOR_API_KEY_HEADER="Turbo-Vector-API-Key",NODE_MODULES_PATH="node_modules/turbo360/dist/vertex",BUCKET="turbo360-vertex",fetchTextFile=function(e){return new Promise(function(r,n){superagent.get(e).query(null).end(function(e,t){if(e)return void n(e);r(t.text)})})},readFile=function(e){return new Promise(function(r,n){fs.readFile(e,"utf8",function(e,t){if(e)return void n(e);r(t)})})},Vertex=function(e){var r=e,n=null,t=function(e){return new Promise(function(t,i){helper.fetchSite(r,!1).then(function(r){if(n=r,"dev"==e){var t=path.join(__dirname,"/pages/global.json").replace(NODE_MODULES_PATH,"");return readFile(t)}return null}).then(function(e){if(null==e)t(n);else try{var r=Object.assign({},n);r.globalConfig=JSON.parse(e),t(r)}catch(e){t(n)}}).catch(function(e){i(e)})})};return{pageData:function(e){return new Promise(function(n,t){if(null==e)return void t(new Error("Please specify page name"));if(0==e.length)return void t(new Error("Please specify page name"));var i=e.toLowerCase().trim(),u="https://cdn.turbo360-vertex.com/pages/"+r.site_id+"-"+i+".json";superagent.get(u).query(null).set("Accept","application/json").end(function(e,r){if(e)return void t(e);n(r.body)})})},rawTemplate:function(e,n,t){return new Promise(function(i,u){if(null==e)return void u(new Error("Please specify template name"));if(0==e.length)return void u(new Error("Please specify template name"));if("dev"==t){var o=path.join(__dirname,"/views/"+e+".mustache").replace(NODE_MODULES_PATH,"");return void fs.readFile(o,"utf8",function(e,r){if(e)return void u(e);i(r)})}helper.fetchSite(r).then(function(r){if(r.api.key!=n)return void u(new Error("Unauthorized"));var t="https://cdn.turbo360-vertex.com/"+r.slug+"/views/"+e+".mustache";return helper.fetchTextFile(t)}).then(function(e){i(e)}).catch(function(e){u(e)})})},pageConfig:function(e,t,i){return new Promise(function(u,o){if(null==e)return void o(new Error("Please specify page name"));if(0==e.length)return void o(new Error("Please specify page name"));if("dev"==i){var a=path.join(__dirname,"/pages/"+e+".json").replace(NODE_MODULES_PATH,"");return void fs.readFile(a,"utf8",function(e,r){if(e)return void o(e);try{u(JSON.parse(r))}catch(e){o(e)}})}helper.fetchSite(r).then(function(r){if(r.api.key!=t)return void o(new Error("Unauthorized"));n=r;var i="https://s3.amazonaws.com/turbo360-vertex/pages/"+n.slug+"/"+e+".txt";return helper.fetchTextFile(i)}).then(function(e){var r=JSON.parse(e);u(r)}).catch(function(e){o(e)})})},updatePage:function(t,i,u){return new Promise(function(o,a){if(0==helper.validateSiteId(r))return void a(new Error("Please Set Your TURBO_APP_ID"));if(r.site_id.length<20)return void a(new Error("Please Set Your TURBO_APP_ID"));if(null==t)return void a(new Error("Please specify page name"));if(0==t.length)return void a(new Error("Please specify page name"));var s=t+".txt";helper.fetchSite(r).then(function(r){if(r.api.key!=u)return void a(new Error("Unauthorized"));n=r;var c={bucket:BUCKET,filename:s,filetype:"text/plain",folder:"pages/"+n.slug},f=e.turbo_url+"/account/uploadurl";superagent.post(f).send(c).set("Accept","application/json").end(function(e,r){if(e)return void a(e);if("success"!=r.body.confirmation)return void a(new Error(r.body.message));var n={name:s,type:"text/plain"};superagent.put(r.body.data.upload).send(i).set("Content-Type",n.type).end(function(e,r){if(e)return void a(e);o({page:t,status:t+" successfully updated"})})})}).catch(function(e){a(e)})})},currentApp:t}};module.exports=Vertex;